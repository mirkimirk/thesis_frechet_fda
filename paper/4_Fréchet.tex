This section will give an introduction to the concept of Fréchet regression
and some background.

\subsection{Fréchet Mean and Variance}
\label{sec:fr mean and variance}

\begin{figure}[h]
    \centering
    % \input{../bld/figures/frechet/1stlastqf.pgf}
    \resizebox{1\textwidth}{!}{\input{../bld/figures/frechet/1stlastqf.pgf}}
    \caption[Two sample qfs]{Plot of two sample qfs, one with predictor value $p = -1$, and the other
    for $p = 1$.}
    \label{fig:1stlastqf}
\end{figure}

\begin{figure}[h]
    \centering
    % \input{../bld/figures/frechet/some_densities.pgf}
    \resizebox{1\textwidth}{!}{\input{../bld/figures/frechet/some_densities.pgf}}
    \caption[Several sampled densities]{Plot of several sample densities.}
    \label{fig:some_densities}
\end{figure}

\begin{figure}[h]
    \centering
    % \input{../bld/figures/frechet/frechet_estimates.pgf}
    \resizebox{1\textwidth}{!}{\input{../bld/figures/frechet/frechet_estimates.pgf}}
    \caption[Estimated pdfs from Fréchet method]{Plot of estimated densities via Fréchet regression method.}
    \label{fig:frechet_estimates}
\end{figure}

\begin{figure}[h]
    \centering
    % \input{../bld/figures/frechet/frechet_estimates_3d.pgf}
    \resizebox{1\textwidth}{!}{\input{../bld/figures/frechet/frechet_estimates_3d.pgf}}
    \caption[Estimated qfs from Fréchet method]{Plot of estimated qfs via Fréchet regression method.}
    \label{fig:frechet_estimates_3d}
\end{figure}

% \begin{figure}[h]
%     \centering
%     % \input{../bld/figures/frechet/all_observations_3d.pgf}
%     \resizebox{1\textwidth}{!}{\input{../bld/figures/frechet/all_observations_3d.pgf}}
%     \caption{Plot of sampled qfs and their predictor values.}
%     \label{fig:all_observations_3d}
% \end{figure}

\begin{figure}[h]
    \centering
    % \input{../bld/figures/frechet/betas.pgf}
    \resizebox{1\textwidth}{!}{\input{../bld/figures/frechet/betas.pgf}}
    \caption[Estimated betas in LQD functional regression]{Plot of estimated betas from
    functional regression with LQD method.}
    \label{fig:betas}
\end{figure}

\begin{figure}[h]
    \centering
    % \input{../bld/figures/frechet/beta0vsmean.pgf}
    \resizebox{1\textwidth}{!}{\input{../bld/figures/frechet/beta0vsmean.pgf}}
    \caption[Equality of mean LQD function and $\beta_0$]{Plot that shows the equality
    of the mean LQD function and $\beta_0$.}
    \label{fig:beta0vsmean}
\end{figure}

\begin{figure}[h]
    \centering
    % \input{../bld/figures/frechet/func_est_vs_true.pgf}
    \resizebox{1\textwidth}{!}{\input{../bld/figures/frechet/func_est_vs_true.pgf}}
    \caption[Comparison: estimated vs. true densities --- LQD]{Estimated
    densities from functional regression with LQD method plotted against the true densities for some selected predictor values.}
    \label{fig:func_est_vs_true}
\end{figure}

\begin{figure}[h]
    \centering
    % \input{../bld/figures/frechet/frechet_est_vs_true.pgf}
    \resizebox{1\textwidth}{!}{\input{../bld/figures/frechet/frechet_est_vs_true.pgf}}
    \caption[Comparison: estimated vs. true densities --- Fréchet]{Estimated
    densities from Fréchet regression plotted against the true densities for some selected
    predictor values.}
    \label{fig:frechet_est_vs_true}
\end{figure}

\begin{figure}[h]
    \centering
    % \input{../bld/figures/frechet/ise_frechet.pgf}
    \resizebox{1\textwidth}{!}{\input{../bld/figures/frechet/ise_frechet.pgf}}
    \caption[Simulation results: boxplot ISE Fréchet]{Boxplot showing distribution of
    ISE from Fréchet estimates in scenario with directly observed densities.}
    \label{fig:ise_frechet}
\end{figure}

\begin{figure}[h]
    \centering
    % \input{../bld/figures/frechet/ise_frechet_denstimation.pgf}
    \resizebox{1\textwidth}{!}{\input{../bld/figures/frechet/ise_frechet_denstimation.pgf}}
    \caption[Simulation results: boxplot ISE Fréchet with density estimation]{Boxplot
    showing distribution of ISE from Fréchet estimates in scenario with additional
    density estimation step to obtain densities.}
    \label{fig:ise_frechet_denstimation}
\end{figure}

\begin{figure}[h]
    \centering
    % \input{../bld/figures/frechet/ise_func_reg_both.pgf}
    \resizebox{\textwidth}{!}{\input{../bld/figures/frechet/ise_func_reg_both.pgf}}
    \caption[Simulation results: boxplot ISE functional regression]{Boxplot showing
    distribution of ISE from functional regression with LQD method in both scenarios.}
    \label{fig:ise_func_reg_both}
\end{figure}


It can be shown that $d_Q(f,g)$ = $d_W(f,g)$, for any two densities $f$ and $g$ in the
space. (Also explain how quantile synchronized mean different and better than naive
cross-sectional mean.)
\begin{lemma}
    \label{lemma:dqeqdw}
    $d_Q = d_W$
\end{lemma}
\begin{proof}
    asdsadasdads
\end{proof}

Then we can see that:
\begin{lemma}
    The Wasserstein-Fréchet mean estimator is given by
    \begin{equation}
        \hat{f}_\oplus(x) = \frac{1}{\hat{q}_\oplus(\hat{F}_\oplus(x))},
    \end{equation}
    with $\hat{q}_\oplus = \frac{1}{n} \sum_{1}^{n} q_i$.
\end{lemma}
\begin{proof}
    By \ref{lemma:dqeqdw}, we can substitute the quantile distance for the
    Wasserstein distance in the computation of the Fréchet mean. We set
    $Q_\oplus(t) = E[Q(t)]$ because $E[Q(t)]$ is the minimizer of
    \begin{equation}
    \label{eq:wf_mean}
        \begin{aligned}
            E[d_w^2(f_i, f_\oplus)]	& =
            E\left[\int_{0}^{1}(F_i^{-1}(t) - F_\oplus^{-1}(t))^2 \,dt\right] \\
                                    & =
            E\left[\int_{0}^{1}(Q_i(t) - Q_\oplus(t))^2 \,dt\right],
        \end{aligned}
    \end{equation}
    see \citet[Chapter~3.1.4]{PanaretosZemel2020}. To compute the corresponding density
    function, use inverse function rule to get
    $f_\oplus(x) = \frac{1}{q_\oplus(F_\oplus(x))}$, which shows that it suffices to
    estimate $q_\oplus$. Remember that
    $q_\oplus = \frac{\mathrm{d}Q_\oplus}{\mathrm{d}t}$. Because of Assumption REFER A1,
    we can pass the differentiation inside the expectation to see
    $q_\oplus = E\left[\frac{\mathrm{d}Q}{\mathrm{d}t}\right]$, which by analogy
    principle suggests to average the sample observed (or previously estimated)
    quantile densities $q_i$ to obtain an estimator $\hat{q}_\oplus$ for $q_\oplus$.
\end{proof}
